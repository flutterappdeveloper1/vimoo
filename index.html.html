<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vimo - Instant Connect</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- PeerJS for Calling -->
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

    <style>
        :root { 
            --primary: #0084ff; --success: #28a745; --danger: #dc3545; 
            --bg: #f0f2f5; --white: #ffffff;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; overflow: hidden; }

        /* Permission Overlay */
        #setup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary);
            color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; text-align: center; padding: 20px; box-sizing: border-box;
        }

        .btn-start { 
            background: white; color: var(--primary); padding: 15px 40px; border: none; 
            border-radius: 30px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 20px;
        }

        /* App Layout */
        #app-container { display: none; height: 100vh; flex-direction: column; }
        header { 
            background: var(--white); padding: 10px 20px; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .main-content { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar (User List) */
        #sidebar { width: 300px; background: white; border-right: 1px solid #ddd; overflow-y: auto; }
        .user-card { 
            padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; 
            display: flex; align-items: center; gap: 10px; transition: 0.2s;
        }
        .user-card:hover { background: #f0f7ff; }
        .online-dot { width: 12px; height: 12px; background: var(--success); border-radius: 50%; border: 2px solid white; }

        /* Chat Area */
        #chat-window { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 75%; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: white; align-self: flex-start; border-bottom-left-radius: 2px; }

        .input-bar { padding: 10px; background: white; display: flex; gap: 10px; align-items: center; }
        .input-bar input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        .action-btn { background: #eee; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; }

        /* Calling Screen */
        #call-ui { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; 
            display: none; flex-direction: column; z-index: 1000; 
        }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { 
            width: 100px; height: 140px; position: absolute; top: 20px; right: 20px; 
            border: 2px solid white; border-radius: 10px; object-fit: cover; 
        }
        .call-controls { 
            position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 20px; 
        }
        .hangup { background: var(--danger); color: white; padding: 15px 30px; border-radius: 50px; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <!-- à§§. à¦¶à§à¦°à§à¦° à¦ªà¦¾à¦°à¦®à¦¿à¦¶à¦¨ à¦¸à§à¦•à§à¦°à¦¿à¦¨ -->
    <div id="setup-overlay">
        <h1>Welcome to Vimo</h1>
        <p>Please allow Camera and Microphone to start chatting instantly.</p>
        <button class="btn-start" onclick="initApp()">Get Started</button>
    </div>

    <!-- à§¨. à¦®à§‡à¦‡à¦¨ à¦…à§à¦¯à¦¾à¦ª à¦¸à§à¦•à§à¦°à¦¿à¦¨ -->
    <div id="app-container">
        <header>
            <div style="font-weight: bold; font-size: 22px; color: var(--primary);">Vimo</div>
            <div id="my-id" style="font-size: 12px; color: #666;"></div>
        </header>

        <div class="main-content">
            <div id="sidebar">
                <div style="padding: 15px; font-weight: bold; border-bottom: 1px solid #eee;">Online Users</div>
                <div id="user-list"></div>
            </div>

            <div id="chat-window">
                <div id="messages">
                    <div style="margin: auto; color: #888;">Select a friend to chat</div>
                </div>
                <div class="input-bar" id="bottom-bar" style="display: none;">
                    <button class="action-btn" onclick="makeCall('audio')">ðŸ“ž</button>
                    <button class="action-btn" onclick="makeCall('video')">ðŸ“¹</button>
                    <input type="text" id="msg-input" placeholder="Type a message...">
                    <button onclick="sendMsg()" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- à§©. à¦­à¦¿à¦¡à¦¿à¦“ à¦•à¦²à¦¿à¦‚ UI -->
    <div id="call-ui">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="call-controls">
            <button class="hangup" onclick="endCall()">End Call</button>
        </div>
    </div>

    <script>
        // --- ðŸŸ¢ à¦à¦–à¦¾à¦¨à§‡ à¦†à¦ªà¦¨à¦¾à¦° à¦¤à¦¥à§à¦¯à¦—à§à¦²à§‹ à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦•à¦°à§à¦¨ (Firebase Config) ðŸŸ¢ ---
        const firebaseConfig = {
  apiKey: "AIzaSyDCKr5EaLVrDkV4TG00ortCiTWIAo5zgjc",
  authDomain: "vimo-d453c.firebaseapp.com",
  databaseURL: "https://vimo-d453c-default-rtdb.firebaseio.com",
  projectId: "vimo-d453c",
  storageBucket: "vimo-d453c.firebasestorage.app",
  messagingSenderId: "258135136638",
  appId: "1:258135136638:web:2f0e0086213343177bbb2f",
  measurementId: "G-6WLGSWKVW9"
};
        // ----------------------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let activePeerID = null;
        let myPeer = null;
        let currentCall = null;
        let localStream = null;

        // à¦…à§à¦¯à¦¾à¦ª à¦¶à§à¦°à§ à¦•à¦°à¦¾à¦° à¦«à¦¾à¦‚à¦¶à¦¨
        async function initApp() {
            try {
                // à§§. à¦ªà¦¾à¦°à¦®à¦¿à¦¶à¦¨ à¦šà¦¾à¦“à§Ÿà¦¾
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                
                // à§¨. à¦…à¦Ÿà§‹à¦®à§‡à¦Ÿà¦¿à¦• à¦…à§à¦¯à¦¾à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¤à§ˆà¦°à¦¿ (Anonymous)
                const res = await auth.signInAnonymously();
                currentUser = res.user;

                document.getElementById('setup-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                document.getElementById('my-id').innerText = "ID: " + currentUser.uid.substring(0,6);

                // à§©. à¦¡à¦¾à¦Ÿà¦¾à¦¬à§‡à¦œà§‡ à¦‡à¦‰à¦œà¦¾à¦° à¦à¦¨à§à¦Ÿà§à¦°à¦¿
                const userRef = db.ref('online_users/' + currentUser.uid);
                userRef.set({
                    uid: currentUser.uid,
                    lastSeen: Date.now()
                });
                userRef.onDisconnect().remove();

                setupPeer();
                listenUsers();
            } catch (err) {
                alert("Permission Denied! Please allow camera/mic to use Vimo.");
                console.error(err);
            }
        }

        // PeerJS à¦¸à§‡à¦Ÿà¦†à¦ª
        function setupPeer() {
            myPeer = new Peer(currentUser.uid);

            myPeer.on('call', call => {
                if(confirm("Incoming Call... Accept?")) {
                    call.answer(localStream);
                    handleCall(call);
                }
            });
        }

        // à¦‡à¦‰à¦œà¦¾à¦° à¦²à¦¿à¦¸à§à¦Ÿ à¦¦à§‡à¦–à¦¾
        function listenUsers() {
            db.ref('online_users').on('value', snap => {
                const list = document.getElementById('user-list');
                list.innerHTML = '';
                snap.forEach(child => {
                    if(child.key !== currentUser.uid) {
                        const div = document.createElement('div');
                        div.className = 'user-card';
                        div.innerHTML = `<div class="online-dot"></div> User-${child.key.substring(0,5)}`;
                        div.onclick = () => selectUser(child.key);
                        list.appendChild(div);
                    }
                });
            });
        }

        // à¦šà§à¦¯à¦¾à¦Ÿ à¦‡à¦‰à¦œà¦¾à¦° à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ à¦•à¦°à¦¾
        function selectUser(id) {
            activePeerID = id;
            document.getElementById('bottom-bar').style.display = 'flex';
            const chatID = [currentUser.uid, id].sort().join('_');

            db.ref('chats/' + chatID).on('value', snap => {
                const box = document.getElementById('messages');
                box.innerHTML = '';
                snap.forEach(msg => {
                    const data = msg.val();
                    const d = document.createElement('div');
                    d.className = `msg ${data.sender === currentUser.uid ? 'sent' : 'received'}`;
                    d.innerText = data.text;
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // à¦®à§‡à¦¸à§‡à¦œ à¦ªà¦¾à¦ à¦¾à¦¨à§‹
        function sendMsg() {
            const text = document.getElementById('msg-input').value;
            if(!text || !activePeerID) return;
            const chatID = [currentUser.uid, activePeerID].sort().join('_');
            db.ref('chats/' + chatID).push({ sender: currentUser.uid, text: text });
            document.getElementById('msg-input').value = '';
        }

        // à¦•à¦² à¦•à¦°à¦¾
        function makeCall(type) {
            if(!activePeerID) return;
            const call = myPeer.call(activePeerID, localStream);
            handleCall(call);
        }

        function handleCall(call) {
            currentCall = call;
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('local-video').srcObject = localStream;
            
            call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });

            call.on('close', () => endCall());
        }

        function endCall() {
            if(currentCall) currentCall.close();
            document.getElementById('call-ui').style.display = 'none';
        }
    </script>
</body>
</html>