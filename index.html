<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vimo</title>

    <!-- Firebase & PeerJS SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

    <style>
        :root { --primary: #0084ff; --success: #28a745; --danger: #dc3545; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; }

        /* Auth UI */
        #auth-container { height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--primary); }
        .auth-card { background: white; padding: 30px; border-radius: 15px; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 12px; margin-top: 10px; font-size: 16px; }
        .btn-main:hover { opacity: 0.9; }

        /* App Layout */
        #app-container { display: none; height: 100vh; flex-direction: column; }
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .main-view { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 280px; background: white; border-right: 1px solid #ddd; overflow-y: auto; }
        .user-item { padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .user-item:hover { background: #f0f7ff; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #ddd; object-fit: cover; }

        /* Chat Window */
        #chat-window { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; position: relative; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 70%; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: white; align-self: flex-start; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; }

        .input-bar { background: white; padding: 12px; display: flex; gap: 10px; align-items: center; }
        .input-bar input { flex: 1; border-radius: 20px; padding: 10px; border: 1px solid #eee; }

        /* Calling Interface */
        #call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 140px; position: absolute; top: 20px; right: 20px; border: 2px solid white; border-radius: 10px; z-index: 1001; }
        .call-actions { position: absolute; bottom: 50px; display: flex; gap: 20px; z-index: 1002; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; font-size: 24px; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Ringing UI */
        #ringing-ui { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); display: none; text-align: center; z-index: 2000; }
    </style>
</head>
<body>

    <!-- ‡ßß. ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® (‡¶≤‡¶ó‡¶á‡¶®/‡¶∏‡¶æ‡¶á‡¶®‡¶Ü‡¶™) -->
    <div id="auth-container">
        <div class="auth-card">
            <h2 id="auth-header" style="color: var(--primary);">Vimo Login</h2>
            <div id="signup-fields" style="display: none;">
                <input type="text" id="auth-name" placeholder="Full Name">
            </div>
            <input type="email" id="auth-email" placeholder="Email Address">
            <input type="password" id="auth-pass" placeholder="Password">
            
            <button class="btn-main" id="primary-btn" onclick="processAuth()">Login</button>
            <p id="toggle-text" style="font-size: 13px; margin-top: 15px; color: #666; cursor: pointer;" onclick="toggleAuthMode()">
                Don't have an account? Sign Up
            </p>
        </div>
    </div>

    <!-- ‡ß®. ‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
    <div id="app-container">
        <header>
            <div style="display: flex; align-items: center; gap: 10px;">
                <img class="avatar" src="https://via.placeholder.com/40">
                <b id="display-name-header">User</b>
            </div>
            <button onclick="logout()" style="background:var(--danger); color:white; padding:5px 12px; border-radius: 5px;">Logout</button>
        </header>

        <div class="main-view">
            <div id="sidebar">
                <div style="padding:15px; font-weight:bold; color:#666; border-bottom:1px solid #eee;">Contacts</div>
                <div id="user-list"></div>
            </div>

            <div id="chat-window">
                <div id="messages"></div>
                <div class="input-bar" id="chat-controls" style="display:none;">
                    <button onclick="document.getElementById('file-input').click()" style="font-size:20px; background:none;">üñºÔ∏è</button>
                    <input type="file" id="file-input" hidden accept="image/*" onchange="shareFile(this)">
                    <button onclick="startCall('audio')" style="font-size:20px; background:none;">üìû</button>
                    <button onclick="startCall('video')" style="font-size:20px; background:none;">üìπ</button>
                    <input type="text" id="msg-input" placeholder="Type a message...">
                    <button onclick="sendText()" style="background:var(--primary); color:white; padding:8px 15px; border-radius:15px;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡ß©. ‡¶∞‡¶ø‡¶Ç‡¶ü‡ßã‡¶® UI -->
    <div id="ringing-ui">
        <h3 id="caller-name">Incoming Call...</h3>
        <div style="display:flex; justify-content:space-around; margin-top:20px;">
            <button onclick="acceptCall()" style="background:var(--success); color:white; padding:12px 25px;">Accept</button>
            <button onclick="rejectCall()" style="background:var(--danger); color:white; padding:12px 25px;">Reject</button>
        </div>
    </div>

    <!-- ‡ß™. ‡¶ï‡¶≤‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
    <div id="call-overlay">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="call-actions">
            <button onclick="toggleCamera()" class="round-btn" style="background:#555;">üì∑</button>
            <button onclick="endCall()" class="round-btn" style="background:var(--danger);">‚úñ</button>
        </div>
    </div>

    <audio id="ring-audio" src="https://www.soundjay.com/phone/phone-calling-1.mp3" loop></audio>

    <script>
        // --- üü¢ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶® üü¢ ---
        const firebaseConfig = {
  apiKey: "AIzaSyDCKr5EaLVrDkV4TG00ortCiTWIAo5zgjc",
  authDomain: "vimo-d453c.firebaseapp.com",
  databaseURL: "https://vimo-d453c-default-rtdb.firebaseio.com",
  projectId: "vimo-d453c",
  storageBucket: "vimo-d453c.firebasestorage.app",
  messagingSenderId: "258135136638",
  appId: "1:258135136638:web:2f0e0086213343177bbb2f",
  measurementId: "G-6WLGSWKVW9"
};
        // -------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let isLoginMode = true;
        let currentUser = null;
        let peer = null;
        let activeRecipient = null;
        let currentCall = null;
        let localStream = null;
        let dataConn = null;

        // --- Auth Toggle ---
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-header').innerText = isLoginMode ? "Vimo Login" : "Vimo Sign Up";
            document.getElementById('primary-btn').innerText = isLoginMode ? "Login" : "Create Account";
            document.getElementById('signup-fields').style.display = isLoginMode ? "none" : "block";
            document.getElementById('toggle-text').innerText = isLoginMode ? "Don't have an account? Sign Up" : "Already have an account? Login";
        }

        // --- Auth Process ---
        async function processAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const name = document.getElementById('auth-name').value;

            if (!email || !pass) return alert("Email and Password are required!");

            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, pass);
                } else {
                    if (!name) return alert("Full Name is required for Sign Up!");
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
                    await db.ref('users/' + res.user.uid).set({
                        name: name,
                        email: email,
                        uid: res.user.uid,
                        status: 'online'
                    });
                }
            } catch (error) {
                alert("Error: " + error.message);
            }
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                initApp();
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vimo Pro - Smart Connect</title>
    
    <!-- üü¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶Ü‡¶á‡¶ï‡¶® ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡¶ø‡¶® üü¢ -->
    <link rel="icon" href="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞_‡¶Ü‡¶á‡¶ï‡¶®_‡¶á‡¶Æ‡ßá‡¶ú_‡¶≤‡¶ø‡¶ô‡ßç‡¶ï_‡¶è‡¶ñ‡¶æ‡¶®‡ßá_‡¶¶‡¶ø‡¶®">

    <!-- Firebase & PeerJS SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

    <style>
        :root { --primary: #0084ff; --success: #28a745; --danger: #dc3545; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; }

        /* Auth UI */
        #auth-container { height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--primary); z-index: 2000; position: relative; }
        .auth-card { background: white; padding: 30px; border-radius: 15px; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 12px; margin-top: 10px; font-size: 16px; }
        .btn-google { background: white; color: #444; border: 1px solid #ddd; width: 100%; padding: 10px; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* App Layout */
        #app-container { display: none; height: 100vh; flex-direction: column; }
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .main-view { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 280px; background: white; border-right: 1px solid #ddd; overflow-y: auto; }
        .user-item { padding: 12px; border-bottom: 1px solid #f9f9f9; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .user-item:hover { background: #f0f7ff; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #eee; object-fit: cover; }

        /* Chat Window */
        #chat-window { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; position: relative; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 70%; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: white; align-self: flex-start; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

        .input-bar { background: white; padding: 12px; display: flex; gap: 10px; align-items: center; }
        .input-bar input { flex: 1; border-radius: 20px; padding: 10px; border: 1px solid #eee; outline: none; }

        /* Calling Overlay */
        #call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 140px; position: absolute; top: 20px; right: 20px; border: 2px solid white; border-radius: 10px; z-index: 3001; background: #222; }
        .call-actions { position: absolute; bottom: 50px; display: flex; gap: 20px; z-index: 3002; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; font-size: 24px; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Incoming Modal */
        #incoming-modal { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); display: none; text-align: center; z-index: 4000; }
    </style>
</head>
<body>

    <!-- ‡ßß. ‡¶≤‡¶ó‡¶á‡¶®/‡¶∏‡¶æ‡¶á‡¶®‡¶Ü‡¶™ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
    <div id="auth-container">
        <div class="auth-card">
            <!-- üü¢ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶≤‡ßã‡¶ó‡ßã ‡¶¨‡¶æ ‡¶Ü‡¶á‡¶ï‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡¶ø‡¶® üü¢ -->
            <img src="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞_‡¶Ü‡¶á‡¶ï‡¶®_‡¶á‡¶Æ‡ßá‡¶ú_‡¶≤‡¶ø‡¶ô‡ßç‡¶ï_‡¶è‡¶ñ‡¶æ‡¶®‡ßá_‡¶¶‡¶ø‡¶®" width="80" style="margin-bottom:10px;">
            <h2 id="auth-title">Vimo Pro</h2>
            <div id="signup-only" style="display:none;">
                <input type="text" id="auth-name" placeholder="Full Name">
            </div>
            <input type="email" id="auth-email" placeholder="Email Address">
            <input type="password" id="auth-pass" placeholder="Password">
            <button class="btn-main" id="btn-auth" onclick="handleAuth()">Login</button>
            <button class="btn-google" onclick="loginWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Sign in with Google
            </button>
            <p id="auth-toggle" style="font-size:13px; margin-top:15px; color:var(--primary); cursor:pointer;" onclick="toggleAuth()">Don't have an account? Sign Up</p>
        </div>
    </div>

    <!-- ‡ß®. ‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
    <div id="app-container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <img id="my-avatar" class="avatar" src="https://via.placeholder.com/40">
                <b id="my-name">User</b>
            </div>
            <button onclick="logout()" style="background:var(--danger); color:white; padding:5px 12px;">Logout</button>
        </header>
        <div class="main-view">
            <div id="sidebar">
                <div style="padding:15px; font-weight:bold; color:#666; border-bottom:1px solid #eee;">Contacts</div>
                <div id="user-list"></div>
            </div>
            <div id="chat-window">
                <div id="messages"></div>
                <div class="input-bar" id="chat-controls" style="display:none;">
                    <button onclick="document.getElementById('file-input').click()" style="font-size:20px; background:none;">üñºÔ∏è</button>
                    <input type="file" id="file-input" hidden accept="image/*" onchange="shareFile(this)">
                    <button onclick="initiateCall('audio')" style="font-size:20px; background:none;">üìû</button>
                    <button onclick="initiateCall('video')" style="font-size:20px; background:none;">üìπ</button>
                    <input type="text" id="msg-input" placeholder="Type a message...">
                    <button onclick="sendMsg()" style="background:var(--primary); color:white; padding:8px 15px; border-radius:15px;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡ß©. ‡¶ï‡¶≤‡¶ø‡¶Ç UI ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶´‡¶æ‡¶á‡¶≤‡¶∏‡¶Æ‡ßÇ‡¶π -->
    <div id="incoming-modal">
        <h3 id="caller-name">Incoming Call...</h3>
        <p id="call-type-label">Someone is calling you</p>
        <div style="display:flex; justify-content:space-around; margin-top:20px;">
            <button onclick="answerCall()" style="background:var(--success); color:white; padding:12px 25px;">Accept</button>
            <button onclick="rejectCall()" style="background:var(--danger); color:white; padding:12px 25px;">Reject</button>
        </div>
    </div>

    <div id="call-overlay">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="call-actions">
            <button id="btn-cam" onclick="toggleCam()" class="round-btn" style="background:#555;">üì∑</button>
            <button id="btn-mic" onclick="toggleMic()" class="round-btn" style="background:#555;">üéôÔ∏è</button>
            <button onclick="endCall()" class="round-btn" style="background:var(--danger);">‚úñ</button>
        </div>
    </div>

    <!-- üü¢ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® üü¢ -->
    <audio id="audio-ring" src="https://www.soundjay.com/phone/phone-calling-1.mp3" loop></audio>
    <audio id="audio-dial" src="https://www.soundjay.com/phone/telephone-ring-03a.mp3" loop></audio>

    <script>
        // --- üü¢ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶® üü¢ ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // -------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let isLogin = true;
        let currentUser, myPeer, activePeerID, currentCall, localStream, dataConn;

        // --- Auth Functions ---
        function toggleAuth() {
            isLogin = !isLogin;
            document.getElementById('auth-title').innerText = isLogin ? "Vimo Login" : "Vimo Sign Up";
            document.getElementById('signup-only').style.display = isLogin ? "none" : "block";
            document.getElementById('btn-auth').innerText = isLogin ? "Login" : "Create Account";
            document.getElementById('auth-toggle').innerText = isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login";
        }

        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const name = document.getElementById('auth-name').value;
            try {
                if(isLogin) await auth.signInWithEmailAndPassword(email, pass);
                else {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.ref('users/' + res.user.uid).set({ name, email, uid: res.user.uid, status: 'online' });
                }
            } catch (e) { alert(e.message); }
        }

        async function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const res = await auth.signInWithPopup(provider);
                await db.ref('users/' + res.user.uid).update({ name: res.user.displayName, email: res.user.email, uid: res.user.uid, status: 'online' });
            } catch (e) { alert(e.message); }
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                initApp();
            } else {
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        // --- App Initialization ---
        function initApp() {
            db.ref('users/' + currentUser.uid).once('value', s => {
                document.getElementById('my-name').innerText = s.val().name;
                if(currentUser.photoURL) document.getElementById('my-avatar').src = currentUser.photoURL;
            });

            myPeer = new Peer(currentUser.uid);
            db.ref('users/' + currentUser.uid).update({ status: 'online' });
            db.ref('users/' + currentUser.uid + '/status').onDisconnect().set('offline');

            // ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶ø‡¶Ç ‡¶ï‡¶≤ ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤
            db.ref('calls/' + currentUser.uid).on('value', snap => {
                const data = snap.val();
                if(data && data.status === 'dialing') {
                    document.getElementById('audio-ring').play();
                    document.getElementById('incoming-modal').style.display = 'block';
                    document.getElementById('caller-name').innerText = data.fromName;
                    document.getElementById('call-type-label').innerText = data.type === 'video' ? "Video Calling..." : "Audio Calling...";
                } else if (!data) {
                    stopAudio();
                    document.getElementById('incoming-modal').style.display = 'none';
                }
            });

            myPeer.on('call', call => { currentCall = call; });
            myPeer.on('connection', conn => {
                conn.on('data', data => { if(data.type === 'img') appendImg(data.blob, 'received'); });
            });

            loadUsers();
        }

        function loadUsers() {
            db.ref('users').on('value', snap => {
                const list = document.getElementById('user-list');
                list.innerHTML = "";
                snap.forEach(u => {
                    if(u.key !== currentUser.uid) {
                        const d = u.val();
                        const div = document.createElement('div');
                        div.className = 'user-item';
                        div.innerHTML = `<img class="avatar" src="https://via.placeholder.com/40"> <div><b>${d.name}</b><br><small>${d.status}</small></div>`;
                        div.onclick = () => selectUser(d.uid);
                        list.appendChild(div);
                    }
                });
            });
        }

        function selectUser(uid) {
            activePeerID = uid;
            document.getElementById('chat-controls').style.display = 'flex';
            dataConn = myPeer.connect(uid);
            const chatID = [currentUser.uid, uid].sort().join('_');
            db.ref('messages/' + chatID).on('value', s => {
                const box = document.getElementById('messages');
                box.innerHTML = "";
                s.forEach(m => {
                    const data = m.val();
                    const d = document.createElement('div');
                    d.className = `msg ${data.sender === currentUser.uid ? 'sent' : 'received'}`;
                    d.innerText = data.text;
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function sendMsg() {
            const text = document.getElementById('msg-input').value;
            if(!text || !activePeerID) return;
            const chatID = [currentUser.uid, activePeerID].sort().join('_');
            db.ref('messages/' + chatID).push({ sender: currentUser.uid, text });
            document.getElementById('msg-input').value = "";
        }

        function shareFile(input) {
            const file = input.files[0];
            if(!file || !dataConn) return;
            const r = new FileReader();
            r.onload = (e) => {
                dataConn.send({ type: 'img', blob: e.target.result });
                appendImg(e.target.result, 'sent');
            };
            r.readAsDataURL(file);
        }

        function appendImg(blob, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `<img src="${blob}" style="width:100%" onclick="window.open(this.src)">`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        // --- üìû Call System (Fix: No Reload) ---
        async function initiateCall(type) {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            if(type === 'audio') localStream.getVideoTracks()[0].enabled = false;
            
            document.getElementById('audio-dial').play();
            db.ref('calls/' + activePeerID).set({
                from: currentUser.uid,
                fromName: document.getElementById('my-name').innerText,
                type: type,
                status: 'dialing'
            });

            const call = myPeer.call(activePeerID, localStream);
            setupCall(call);
        }

        async function answerCall() {
            stopAudio();
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            
            db.ref('calls/' + currentUser.uid).once('value', s => {
                if(s.val().type === 'audio') localStream.getVideoTracks()[0].enabled = false;
            });

            currentCall.answer(localStream);
            setupCall(currentCall);
            db.ref('calls/' + currentUser.uid).remove();
        }

        function setupCall(call) {
            currentCall = call;
            document.getElementById('call-overlay').style.display = 'flex';
            document.getElementById('local-video').srcObject = localStream;
            call.on('stream', s => { document.getElementById('remote-video').srcObject = s; });
            call.on('close', cleanupCall);
        }

        function cleanupCall() {
            if(localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('remote-video').srcObject = null;
            document.getElementById('local-video').srcObject = null;
            stopAudio();
        }

        function endCall() {
            if(currentCall) currentCall.close();
            db.ref('calls/' + activePeerID).remove();
            db.ref('calls/' + currentUser.uid).remove();
            cleanupCall();
        }

        function rejectCall() {
            db.ref('calls/' + currentUser.uid).remove();
            stopAudio();
        }

        function stopAudio() {
            document.getElementById('audio-ring').pause();
            document.getElementById('audio-ring').currentTime = 0;
            document.getElementById('audio-dial').pause();
            document.getElementById('audio-dial').currentTime = 0;
        }

        function toggleCam() {
            const tracks = localStream.getVideoTracks();
            if(tracks.length > 0) {
                tracks[0].enabled = !tracks[0].enabled;
                document.getElementById('btn-cam').style.background = tracks[0].enabled ? "#555" : "var(--danger)";
            }
        }

        function toggleMic() {
            const tracks = localStream.getAudioTracks();
            if(tracks.length > 0) {
                tracks[0].enabled = !tracks[0].enabled;
                document.getElementById('btn-mic').style.background = tracks[0].enabled ? "#555" : "var(--danger)";
            }
        }

        function logout() {
            db.ref('users/' + currentUser.uid).update({ status: 'offline' });
            auth.signOut();
        }
    </script>
</body>
</html>
