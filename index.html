<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vimo - Instant Connect</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- PeerJS for Calling -->
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

    <style>
        :root { 
            --primary: #0084ff; --success: #28a745; --danger: #dc3545; 
            --bg: #f0f2f5; --white: #ffffff;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; overflow: hidden; }

        /* Permission Overlay */
        #setup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary);
            color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; text-align: center; padding: 20px; box-sizing: border-box;
        }

        .btn-start { 
            background: white; color: var(--primary); padding: 15px 40px; border: none; 
            border-radius: 30px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 20px;
        }

        /* App Layout */
        #app-container { display: none; height: 100vh; flex-direction: column; }
        header { 
            background: var(--white); padding: 10px 20px; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .main-content { display: flex; flex: 1; overflow: hidden; }
            /* Sidebar (User List) */
        #sidebar { width: 300px; background: white; border-right: 1px solid #ddd; overflow-y: auto; }
        .user-card { 
            padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; 
            display: flex; align-items: center; gap: 10px; transition: 0.2s;
        }
        .user-card:hover { background: #f0f7ff; }
        .online-dot { width: 12px; height: 12px; background: var(--success); border-radius: 50%; border: 2px solid white; }

        /* Chat Area */
        #chat-window { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 75%; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: white; align-self: flex-start; border-bottom-left-radius: 2px; }

        .input-bar { padding: 10px; background: white; display: flex; gap: 10px; align-items: center; }
        .input-bar input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        .action-btn { background: #eee; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; }

        /* Calling Screen */
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

    <style>
        :root { --p: #0084ff; --s: #28a745; --d: #dc3545; --bg: #f0f2f5; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); overflow: hidden; }
        button { cursor: pointer; border-radius: 5px; border: none; }
        
        /* Auth UI */
        #auth-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--p); }
        .card { background: white; padding: 30px; border-radius: 15px; width: 300px; text-align: center; }
        input { width: 90%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; }

        /* App Layout */
        #app-screen { display: none; height: 100vh; flex-direction: column; }
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .main { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 280px; background: white; border-right: 1px solid #ddd; overflow-y: auto; }
        .u-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .u-item:hover { background: #f9f9f9; }
        .u-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; }

        /* Chat */
        #chat-area { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; }
        #msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 70%; font-size: 15px; }
        .msg img { max-width: 200px; border-radius: 5px; display: block; margin-top: 5px; }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: white; align-self: flex-start; }

        .input-bar { background: white; padding: 10px; display: flex; gap: 10px; align-items: center; }
        
        /* Calling Modal */
        #call-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
            display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 1000;
        }
        #video-grid { width: 100%; height: 100%; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #local-v { width: 120px; height: 160px; position: absolute; top: 20px; right: 20px; border: 2px solid white; }
        .call-ctrls { position: absolute; bottom: 30px; display: flex; gap: 20px; }

        /* Incoming Modal */
        #incoming-modal {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 300px; 
            background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none; text-align: center; z-index: 2000;
        }
    </style>
</head>
<body>

    <!-- ‡ßß. ‡¶≤‡¶ó‡¶á‡¶®/‡¶∏‡¶æ‡¶á‡¶®‡¶Ü‡¶™ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
    <div id="auth-screen">
        <div class="card">
            <h2>Vimo Pro</h2>
            <input type="text" id="user-id" placeholder="Username (Display Name)">
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Password">
            <input type="file" id="profile-pic" accept="image/*" style="font-size: 12px;">
            <p style="font-size: 11px;">Profile Picture (Optional)</p>
            <button onclick="handleAuth('up')" style="background: var(--s); color: white; padding: 10px 20px;">Sign Up</button>
            <button onclick="handleAuth('in')" style="background: var(--p); color: white; padding: 10px 20px;">Login</button>
        </div>
    </div>

    <!-- ‡ß®. ‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ -->
    <div id="app-screen">
        <header>
            <div style="display: flex; align-items: center; gap: 10px;">
                <img id="my-avatar" class="u-img">
                <b id="my-name"></b>
            </div>
            <button onclick="location.reload()" style="background: var(--d); color: white; padding: 5px 10px;">Logout</button>
        </header>
        <div class="main">
            <div id="sidebar"></div>
            <div id="chat-area">
                <div id="msgs"></div>
                <div class="input-bar" id="input-ui" style="display: none;">
                    <button onclick="triggerImg()">üñºÔ∏è</button>
                    <input type="file" id="img-input" hidden accept="image/*" onchange="sendImg(this)">
                    <button onclick="startCall('audio')">üìû</button>
                    <button onclick="startCall('video')">üìπ</button>
                    <input type="text" id="m-input" placeholder="Type message...">
                    <button onclick="sendMsg()" style="background: var(--p); color: white; padding: 10px;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡ß©. ‡¶ï‡¶≤‡¶ø‡¶Ç UI -->
    <div id="call-modal">
        <div id="video-grid">
            <video id="remote-v" autoplay playsinline></video>
            <video id="local-v" autoplay muted playsinline></video>
        </div>
        <div class="call-ctrls">
            <button onclick="toggleCam()" id="cam-btn" style="padding: 15px; background: grey;">üì∑ Toggle Camera</button>
            <button onclick="endCall()" style="padding: 15px 30px; background: var(--d); color: white; border-radius: 50px;">End Call</button>
        </div>
    </div>

    <!-- ‡ß™. ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡¶ø‡¶Ç ‡¶ï‡¶≤ ‡¶∞‡¶ø‡¶Ç‡¶ø‡¶Ç UI -->
    <div id="incoming-modal">
        <h3 id="caller-name">Incoming Call...</h3>
        <p id="call-type-label"></p>
        <div style="display: flex; justify-content: space-around;">
            <button onclick="acceptCall()" style="background: var(--s); color: white; padding: 10px 20px;">Accept</button>
            <button onclick="rejectCall()" style="background: var(--d); color: white; padding: 10px 20px;">Reject</button>
        </div>
    </div>

    <audio id="ringtone" src="https://www.soundjay.com/phone/phone-calling-1.mp3" loop></audio>

    <script>
        // --- üî¥ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase Config ‡¶¶‡¶ø‡¶® üî¥ ---
        const firebaseConfig = {
  apiKey: "AIzaSyDCKr5EaLVrDkV4TG00ortCiTWIAo5zgjc",
  authDomain: "vimo-d453c.firebaseapp.com",
  databaseURL: "https://vimo-d453c-default-rtdb.firebaseio.com",
  projectId: "vimo-d453c",
  storageBucket: "vimo-d453c.firebasestorage.app",
  messagingSenderId: "258135136638",
  appId: "1:258135136638:web:2f0e0086213343177bbb2f",
  measurementId: "G-6WLGSWKVW9"
};
        // --------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        let currentUser, myPeer, activeChatID, currentCall, localStream, peerID;
        const ringtone = document.getElementById('ringtone');

        // --- ‡ßß. ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® (Sign Up & Login) ---
        async function handleAuth(type) {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            const name = document.getElementById('user-id').value;
            const file = document.getElementById('profile-pic').files[0];

            if(!email || !pass) return alert("Email/Pass required");

            try {
                let res;
                if(type === 'up') {
                    res = await auth.createUserWithEmailAndPassword(email, pass);
                    let url = "";
                    if(file) {
                        const sRef = storage.ref('avatars/' + res.user.uid);
                        await sRef.put(file);
                        url = await sRef.getDownloadURL();
                    }
                    await db.ref('users/' + res.user.uid).set({ name, email, avatar: url, uid: res.user.uid });
                } else {
                    res = await auth.signInWithEmailAndPassword(email, pass);
                }
            } catch (e) { alert(e.message); }
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                db.ref('users/' + user.uid).once('value', s => {
                    const data = s.val();
                    document.getElementById('my-name').innerText = data.name;
                    document.getElementById('my-avatar').src = data.avatar || 'https://via.placeholder.com/40';
                    initApp();
                });
            }
        });

        function initApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            
            myPeer = new Peer(currentUser.uid);
            
            // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶°
            db.ref('users').on('value', s => {
                const side = document.getElementById('sidebar');
                side.innerHTML = "";
                s.forEach(u => {
                    if(u.key !== currentUser.uid) {
                        const d = u.val();
                        const div = document.createElement('div');
                        div.className = 'u-item';
                        div.innerHTML = `<img class="u-img" src="${d.avatar || 'https://via.placeholder.com/40'}"> <b>${d.name}</b>`;
                        div.onclick = () => openChat(d);
                        side.appendChild(div);
                    }
                });
            });

            // ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡¶ø‡¶Ç ‡¶ï‡¶≤ ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞
            db.ref('calls/' + currentUser.uid).on('value', s => {
                const data = s.val();
                if(data && data.status === 'ringing') {
                    showIncoming(data);
                } else if (!data) {
                    hideIncoming();
                }
            });

            myPeer.on('call', call => {
                currentCall = call;
            });
        }

        // --- ‡ß®. ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶á‡¶Æ‡ßá‡¶ú ‡¶∂‡ßá‡ßü‡¶æ‡¶∞‡¶ø‡¶Ç ---
        function openChat(user) {
            peerID = user.uid;
            document.getElementById('input-ui').style.display = 'flex';
            const chatID = [currentUser.uid, user.uid].sort().join('_');
            activeChatID = chatID;

            db.ref('msgs/' + chatID).on('value', s => {
                const box = document.getElementById('msgs');
                box.innerHTML = "";
                s.forEach(m => {
                    const d = m.val();
                    const div = document.createElement('div');
                    div.className = `msg ${d.sender === currentUser.uid ? 'sent' : 'received'}`;
                    if(d.type === 'img') div.innerHTML = `<img src="${d.url}">`;
                    else div.innerText = d.text;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function sendMsg() {
            const t = document.getElementById('m-input').value;
            if(!t) return;
            db.ref('msgs/' + activeChatID).push({ sender: currentUser.uid, text: t, type: 'text' });
            document.getElementById('m-input').value = "";
        }

        function triggerImg() { document.getElementById('img-input').click(); }

        async function sendImg(input) {
            const file = input.files[0];
            if(!file) return;
            const ref = storage.ref('chats/' + Date.now());
            await ref.put(file);
            const url = await ref.getDownloadURL();
            db.ref('msgs/' + activeChatID).push({ sender: currentUser.uid, url: url, type: 'img' });
        }

        // --- ‡ß©. ‡¶ï‡¶≤‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ (Audio/Video + Ringing) ---
        async function startCall(type) {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            if(type === 'audio') localStream.getVideoTracks()[0].enabled = false;
            
            // ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
            db.ref('calls/' + peerID).set({
                from: currentUser.uid,
                fromName: document.getElementById('my-name').innerText,
                type: type,
                status: 'ringing'
            });

            const call = myPeer.call(peerID, localStream);
            showCallUI(call);
        }

        function showIncoming(data) {
            ringtone.play();
            document.getElementById('incoming-modal').style.display = 'block';
            document.getElementById('caller-name').innerText = data.fromName;
            document.getElementById('call-type-label').innerText = data.type === 'video' ? "Video Call..." : "Audio Call...";
        }

        function hideIncoming() {
            ringtone.pause();
            ringtone.currentTime = 0;
            document.getElementById('incoming-modal').style.display = 'none';
        }

        async function acceptCall() {
            hideIncoming();
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            
            // ‡¶Ø‡¶¶‡¶ø ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶ï‡¶≤ ‡¶π‡ßü, ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶Ö‡¶´ ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vimo - Chat & Call</title>

    <!-- Firebase & PeerJS SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

    <style>
        :root { --primary: #0084ff; --success: #28a745; --danger: #dc3545; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; }

        /* Auth UI */
        #auth-container { height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--primary); }
        .auth-card { background: white; padding: 30px; border-radius: 15px; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 12px; margin-top: 10px; }

        /* Main App Layout */
        #app-container { display: none; height: 100vh; flex-direction: column; }
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .main-view { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 280px; background: white; border-right: 1px solid #ddd; overflow-y: auto; }
        .user-item { padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .user-item:hover { background: #f0f7ff; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #ddd; object-fit: cover; }
        .status-online { width: 10px; height: 10px; background: var(--success); border-radius: 50%; }

        /* Chat Area */
        #chat-window { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; position: relative; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 70%; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: white; align-self: flex-start; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; }

        .input-bar { background: white; padding: 12px; display: flex; gap: 10px; align-items: center; }
        .input-bar input { flex: 1; margin: 0; border-radius: 20px; }

        /* Calling Interface */
        #call-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; 
            z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 120px; height: 160px; position: absolute; top: 20px; right: 20px; border: 2px solid white; border-radius: 10px; z-index: 1001; }
        .call-actions { position: absolute; bottom: 50px; display: flex; gap: 20px; z-index: 1002; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; font-size: 24px; color: white; display: flex; align-items: center; justify-content: center; }

        /* Ringing UI */
        #ringing-ui {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px;
            background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            display: none; text-align: center; z-index: 2000;
        }
    </style>
</head>
<body>

    <!-- ‡ßß. ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® -->
    <div id="auth-container">
        <div class="auth-card">
            <h2 style="color: var(--primary);">Vimo Connect</h2>
            <input type="text" id="reg-name" placeholder="User Display Name">
            <input type="email" id="reg-email" placeholder="Email Address">
            <input type="password" id="reg-pass" placeholder="Password">
            <button class="btn-main" onclick="handleAuth('signup')">Create Account</button>
            <button class="btn-main" style="background:none; color:var(--primary);" onclick="handleAuth('login')">Already have an account? Login</button>
        </div>
    </div>

    <!-- ‡ß®. ‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
    <div id="app-container">
        <header>
            <div style="display: flex; align-items: center; gap: 10px;">
                <img id="my-avatar" class="avatar" src="https://via.placeholder.com/40">
                <b id="my-display-name">Vimo User</b>
            </div>
            <button onclick="logout()" style="background:var(--danger); color:white; padding:5px 12px;">Logout</button>
        </header>

        <div class="main-view">
            <div id="sidebar">
                <div style="padding:15px; font-weight:bold; color:#666; border-bottom:1px solid #eee;">Contacts</div>
                <div id="user-list"></div>
            </div>

            <div id="chat-window">
                <div id="messages"></div>
                <div class="input-bar" id="chat-controls" style="display:none;">
                    <button onclick="document.getElementById('file-input').click()" style="font-size:20px;">üñºÔ∏è</button>
                    <input type="file" id="file-input" hidden accept="image/*" onchange="shareFile(this)">
                    <button onclick="startCall('audio')" style="font-size:20px;">üìû</button>
                    <button onclick="startCall('video')" style="font-size:20px;">üìπ</button>
                    <input type="text" id="msg-input" placeholder="Type a message...">
                    <button onclick="sendText()" class="btn-main" style="width:auto; margin:0; padding:10px 20px;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡ß©. ‡¶∞‡¶ø‡¶Ç‡¶ü‡ßã‡¶® ‡¶è‡¶¨‡¶Ç ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡¶ø‡¶Ç ‡¶ï‡¶≤ UI -->
    <div id="ringing-ui">
        <h3 id="caller-name">Incoming Call...</h3>
        <p id="call-type">Someone is calling you</p>
        <div style="display:flex; justify-content:space-around; margin-top:20px;">
            <button onclick="acceptCall()" style="background:var(--success); color:white; padding:12px 25px;">Accept</button>
            <button onclick="rejectCall()" style="background:var(--danger); color:white; padding:12px 25px;">Reject</button>
        </div>
    </div>

    <!-- ‡ß™. ‡¶ï‡¶≤‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
    <div id="call-overlay">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="call-actions">
            <button onclick="toggleCamera()" id="cam-toggle" class="round-btn" style="background:#555;">üì∑</button>
            <button onclick="toggleMic()" id="mic-toggle" class="round-btn" style="background:#555;">üéôÔ∏è</button>
            <button onclick="endCall()" class="round-btn" style="background:var(--danger);">‚úñ</button>
        </div>
    </div>

    <audio id="ring-audio" src="https://www.soundjay.com/phone/phone-calling-1.mp3" loop></audio>

    <script>
        // --- üü¢ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶® üü¢ ---
        const firebaseConfig = {
  apiKey: "AIzaSyDCKr5EaLVrDkV4TG00ortCiTWIAo5zgjc",
  authDomain: "vimo-d453c.firebaseapp.com",
  databaseURL: "https://vimo-d453c-default-rtdb.firebaseio.com",
  projectId: "vimo-d453c",
  storageBucket: "vimo-d453c.firebasestorage.app",
  messagingSenderId: "258135136638",
  appId: "1:258135136638:web:2f0e0086213343177bbb2f",
  measurementId: "G-6WLGSWKVW9"
};
        // -------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let peer = null;
        let activeRecipient = null;
        let currentCall = null;
        let localStream = null;
        let dataConn = null; // PeerJS Data Connection for direct image sharing

        // --- ‡ßß. ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ---
        async function handleAuth(type) {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const name = document.getElementById('reg-name').value;

            try {
                if(type === 'signup') {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.ref('users/' + res.user.uid).set({ name, email, uid: res.user.uid, status: 'online' });
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
            } catch (e) { alert(e.message); }
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                initApp();
            } else {
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        function initApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            db.ref('users/' + currentUser.uid).once('value', s => {
                document.getElementById('my-display-name').innerText = s.val().name;
            });

            // PeerJS ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶®
            peer = new Peer(currentUser.uid);

            peer.on('open', id => {
                db.ref('users/' + currentUser.uid).update({ status: 'online' });
            });

            // ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡¶ø‡¶Ç ‡¶ï‡¶≤ ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ (‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶∞‡¶ø‡¶Ç‡¶ü‡ßã‡¶® ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü)
            db.ref('signals/' + currentUser.uid).on('value', snap => {
                const signal = snap.val();
                if(signal && signal.type === 'offer') {
                    showRinging(signal);
                } else if(!signal) {
                    stopRinging();
                }
            });

            // ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡¶ø‡¶Ç ‡¶ï‡¶≤ ‡¶∞‡¶ø‡¶∏‡¶ø‡¶≠
            peer.on('call', call => {
                currentCall = call;
            });

            // ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡¶ø‡¶Ç ‡¶°‡ßá‡¶ü‡¶æ (‡¶á‡¶Æ‡ßá‡¶ú) ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞
            peer.on('connection', conn => {
                conn.on('data', data => {
                    if(data.type === 'image') displayImage(data.blob, 'received');
                });
            });

            loadUsers();
        }

        // --- ‡ß®. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ì ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ---
        function loadUsers() {
            db.ref('users').on('value', snap => {
                const list = document.getElementById('user-list');
                list.innerHTML = "";
                snap.forEach(child => {
                    if(child.key !== currentUser.uid) {
                        const u = child.val();
                        const div = document.createElement('div');
                        div.className = 'user-item';
                        div.innerHTML = `<img class="avatar" src="https://via.placeholder.com/40"> 
                                        <div style="flex:1"><b>${u.name}</b><br><small>${u.status}</small></div>
                                        <div class="${u.status === 'online' ? 'status-online' : ''}"></div>`;
                        div.onclick = () => selectUser(u.uid);
                        list.appendChild(div);
                    }
                });
            });
        }

        function selectUser(uid) {
            activeRecipient = uid;
            document.getElementById('chat-controls').style.display = 'flex';
            dataConn = peer.connect(uid); // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶∂‡ßá‡ßü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶®
            
            const chatID = [currentUser.uid, uid].sort().join('_');
            db.ref('messages/' + chatID).off();
            db.ref('messages/' + chatID).on('value', snap => {
                const box = document.getElementById('messages');
                box.innerHTML = "";
                snap.forEach(m => {
                    const data = m.val();
                    const d = document.createElement('div');
                    d.className = `msg ${data.sender === currentUser.uid ? 'sent' : 'received'}`;
                    d.innerText = data.text;
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function sendText() {
            const text = document.getElementById('msg-input').value;
            if(!text || !activeRecipient) return;
            const chatID = [currentUser.uid, activeRecipient].sort().join('_');
            db.ref('messages/' + chatID).push({ sender: currentUser.uid, text: text, time: Date.now() });
            document.getElementById('msg-input').value = "";
        }

        // --- ‡ß©. ‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶á‡¶Æ‡ßá‡¶ú ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ (PeerJS - No Firebase Cost) ---
        function shareFile(input) {
            const file = input.files[0];
            if(!file || !dataConn) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const blob = e.target.result;
                dataConn.send({ type: 'image', blob: blob });
                displayImage(blob, 'sent');
            };
            reader.readAsDataURL(file);
        }

        function displayImage(blob, type) {
            const box = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `<img src="${blob}" onclick="window.open(this.src)">`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- ‡ß™. ‡¶ï‡¶≤‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶ì ‡¶∞‡¶ø‡¶Ç‡¶ü‡ßã‡¶® ---
        async function startCall(mode) {
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: true, 
                audio: true 
            });
            
            // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶Æ‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¨‡¶®‡ßç‡¶ß ‡¶∞‡¶æ‡¶ñ‡¶æ
            if(mode === 'audio') localStream.getVideoTracks()[0].enabled = false;

            db.ref('signals/' + activeRecipient).set({
                type: 'offer',
                from: currentUser.uid,
                fromName: document.getElementById('my-display-name').innerText,
                mode: mode
            });

            const call = peer.call(activeRecipient, localStream);
            handleCallUI(call);
        }

        function showRinging(signal) {
            document.getElementById('ring-audio').play();
            document.getElementById('ringing-ui').style.display = 'block';
            document.getElementById('caller-name').innerText = signal.fromName;
            document.getElementById('call-type').innerText = signal.mode === 'video' ? "Video Calling..." : "Audio Calling...";
        }

        function stopRinging() {
            document.getElementById('ring-audio').pause();
            document.getElementById('ring-audio').currentTime = 0;
            document.getElementById('ringing-ui').style.display = 'none';
        }

        async function acceptCall() {
            stopRinging();
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            
            db.ref('signals/' + currentUser.uid).once('value', s => {
                if(s.val().mode === 'audio') localStream.getVideoTracks()[0].enabled = false;
            });

            currentCall.answer(localStream);
            handleCallUI(currentCall);
            db.ref('signals/' + currentUser.uid).remove();
        }

        function rejectCall() {
            db.ref('signals/' + currentUser.uid).remove();
            stopRinging();
        }

        function handleCallUI(call) {
            currentCall = call;
            document.getElementById('call-overlay').style.display = 'flex';
            document.getElementById('local-video').srcObject = localStream;
            
            call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });

            call.on('close', () => endCall());
        }

        // ‡¶ï‡¶≤ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶∏
        function toggleCamera() {
            const enabled = localStream.getVideoTracks()[0].enabled;
            localStream.getVideoTracks()[0].enabled = !enabled;
            document.getElementById('cam-toggle').style.background = !enabled ? "#555" : "#333";
        }

        function toggleMic() {
            const enabled = localStream.getAudioTracks()[0].enabled;
            localStream.getAudioTracks()[0].enabled = !enabled;
            document.getElementById('mic-toggle').style.background = !enabled ? "#555" : "#333";
        }

        function endCall() {
            if(currentCall) currentCall.close();
            if(localStream) localStream.getTracks().forEach(track => track.stop());
            db.ref('signals/' + activeRecipient).remove();
            document.getElementById('call-overlay').style.display = 'none';
            location.reload();
        }

        function logout() {
            db.ref('users/' + currentUser.uid).update({ status: 'offline' });
            auth.signOut();
        }

    </script>
</body>
</html>
